---
title: "Data Manipulation and Visualization"
author: "Instructors: Daniel Falster, Will Cornwell, Dony Indiarto"
date: "Feb 2020"
output: html_document
---

# Introduction to using Rmarkdown (Rmd)


- File extension `*.Rmd`
- Can be notebook or markdown
- Includes text and code -> good for note taking 

Code chunks:

- typical R code
- are embedded in wrapper

```{r}

```

Text written in markdown

- Headers: `#`
- Bold: `**bold**`
- links: `[text](link)`

Hotcake short-cuts:

- in the top right of code

# Introduction to Movies data (Dan)

```{r}
library(tidyverse)
data <- read_csv("data/movie_profit/movie_profit.csv")
```

What variables?
```{r}
names(data)
```

An overview of the data

```{r}
View(data)
```

or summarise using the `skimr` package:

```{r}
skimr::skim(data)
```


# What is the tidyverse? (Dan)

* The [Tidyverse](http://tidyverse.org) is the name given to suite of R packages designed for seamless data analysis
* Designed to help you fall into a **"Pit of Success"**
* Tools designed for: 1) Turning data into tidy data, and 2) Plotting & analysing Tidy Data
* Dataframes (tibbles) are the universal "tidy" input and output
* Not one but a collection packages

Load individually or all together

```{r, eval = FALSE}
library(dplyr)
library(readr)
library(tidyr)
library(ggplot2)
```
or
```{r, eval = FALSE}
library(tidyverse)
```

## `tibble` - A better data frame 


* Prints a short summary at console
* Generates suitable warnings 
* Won't convert strings to factors
* No partial column-name matching
* Behaves consistently with `[` and `[[`
* [tibble.tidyverse.org](tibble.tidyverse.org)

```{r}
data
```

# Reading data with `readr` (Dan)

Where possible, we recommend using 

- `csv` files (common separated files) to store data
- the `readr` package to load data

Why `readr`?

* Fast
* Won't convert strings to factors
* Can control how columns are parsed

```{r}
data <- read_csv("data/movie_profit/movie_profit.csv")
```

Has a bunch of extra arguments:

- guess_max
- trim_ws
- skip
- na

Tries to guess column types. Can override this by specifying exactly:


All characters
```{r}

read_csv("data/movie_profit/movie_profit.csv", 
         col_types = cols(.default = col_character())
)
```

Specify by variable:

```{r}
read_csv("data/movie_profit/movie_profit.csv", 
         col_types = cols(
           X1 = col_integer(),
           release_date = col_character(),
           movie = col_character(),
           production_budget = col_double(),
           domestic_gross = col_double(),
           worldwide_gross = col_double(),
           distributor = col_character(),
           mpaa_rating = col_character(),
           genre = col_character()
         )
)
```

Also other variants

- `read_tsv`: load tab-separated data
- `read_delim`: load file by specifying the delimiter

```{r}
read_delim("data/movie_profit/movie_profit.csv", ",")
```

To load data from excel spreadsheets, try the `readxl` package.

## Exercises

1. Use `read_csv` to load data file `data/plant_height/plantHeightSingleSpp.csv`

2. Use `read_csv` to load data file `data/sydney_beaches/temperature.csv`


# Data manipulation with `dplyr` (Dan)

Motivation:

- Data is never organized in the way you want it 
- High % of project is data wrangling
- Many many many modern jobs are data wrangling

Key ideas:

- Data is a noun
- Actions on data are verbs  

Main actions are verbs describing effect on data

- `select` -> subset columns 
- `filter` -> subset rows 
- `arrange`  –> order rows
- `rename`    –> rename variables
- `mutate`  –> make new variables
- `summarise`  –> summarise data
- `distinct` -> filter to each unique row


**Exercises:**

## Pipes


## Use "the pipe" [%>%](http://magrittr.tidyverse.org/reference/pipe.html) to connect expressions

* `%>%` "pipes" the **output** of the last expression as the **first input** of the next expression
* If you use RStudio, you can type the pipe with Ctrl + Shift + M if you have a PC or Cmd + Shift + M if you have a Mac.
* `%>%` is an **infix operator** -> expects commands on left & right
* Comes from the [magrittr](http://magrittr.tidyverse.org/reference/pipe.html) package


```{r}
data$distributor %>% unique()
```

```{r}
data$distributor %>% unique() %>% length()
data$distributor %>% n_distinct()
```

But you can control the input position of the next function with `.`:
```{r}
20 %>% seq(1, 4, length.out = .)
```

## Use pipes to join data verbs to make a data sentence

Tidyverse functions are written to work with pipes, i.e. most take the data as the first argument.

```{r}
data %>% filter(distributor == "Universal")
```
is the same as

```{r}
filter(data, distributor == "Universal")
```



```{r}
data %>%
  filter(distributor == "Universal") %>%
  select(movie, mpaa_rating)
```


**Exercises:** Apply the `dplyr` package and your new data wrangling skills to the movies dataset to 


1. Create a subset of the dataset consisting of only movies with budget < XXX
2. As above and only variables `XXX`, `XXX`, and `Longitude`
3. As above but with only one record per XXXX
3. As above but with data sorted by `XXXX`
4. Mutate a column to calculate XXX

# Imagine your plot (Will)

# Intro to data visualisation with `ggplot2` (Dony)

See slides in "slides/Visualisation_slides.Rmd"

**Examples from the slides**

Read and inspect the data
```{r}
library(tidyverse)
movies <- read_csv("../data/movie_profit/movie_profit.csv")
glimpse(movies) # see every column in the data frame
```

Q1 What are the most common genres? 

```{r}
ggplot(movies,         # the data
       aes(x= genre))+ # what to plot
  geom_bar()           # type of plot

```


Q1 And put some colour on...
```{r }
ggplot(movies,                        # the data
       aes(x = genre, fill = genre))+ # what to plot
  geom_bar()                          # type of plot

```

Q2 What genres are more expensive to produce?
```{r}
ggplot(movies, aes(x = genre, y = production_budget))+
  geom_boxplot()
```


Q3 What genres make the highest profit?

```{r fig.height=3, message=FALSE, warning=FALSE, dev='svg', highlight.output=c(1)}
ggplot(movies, aes(x = genre, y = worldwide_gross))+
  geom_boxplot()
```

Q3 re-scale so we can see more variation...

```{r fig.height=3, message=FALSE, warning=FALSE, dev='svg', highlight.output=c(3)}
ggplot(movies,aes(x = genre, y = worldwide_gross))+
  geom_boxplot() +
  scale_y_log10()
```


**Exercise**:
Try to answer these questions below by making some relevant figures

**Q1 Are there more cheap films?**

 - Hint: create a histogram-plot with production_budget at the x-axis
   
**Q2 What genres make the highest return on investment?**

 - Hints
   - calculate the ratio of worldwide gross profit and production budget
   - create a box-plot with x-axis representing the genre and y-axis representing the ratio
   - Rescale y-axis to log scale
   
**Q3 What genres make the highest return on investment?**

 - Hints
   - create a scatter plot with with the x-axis representing the production_budget and the y-axis representing the worldwide_gross profit
   - Rescale the x- and y-axis to log scale
   - add regression line with `stat_smooth()`


# Introduction to gapminder data (Dan)


https://github.com/jennybc/gapminder

# Tidy Data concept (Dony)
- What is tidy data?
- Converting from long to wide data
- see slides in slides/tidy_data_pivot_tables.pdf

Read and inspect the structure of life_expectancy_years.csv
```{r}
library(tidyverse)
le <- read_csv("data/gapminder/life_expectancy_years.csv") # read the worldwide life expectancy data

skimr::skim(le) #summarise using the `skimr

View(le) #An overview of the data
```


Make the 'life expectancy' data tidy with `dplyr::pivot_longer( )`
```{r}
le_long<- 
  pivot_longer(data = le, # the data
               
                      # pivot all column into longer format except 'country'
                      cols=-country, 
               
                      #the name of the column made from the data stored in the col.names
                      names_to="year", 
                  
                      #the name of the column made from the data stored in the cells
                      values_to = "life_exp") 

View(le_long)
```

Make a figure of life expectancy trend over time
```{r}
 ggplot(le_long,                                   #data
 aes(x = year, y = life_exp, group = country)) +   #aesthetics
 geom_line() +	                                   #type of plot
 theme(legend.position ="none")                    #remove legend

```

Make the long 'life expectancy' data back to its original form with `dplyr::pivot_wider( )`

```{r}
le_wide <- pivot_wider(data = le_long,           #the data
                        names_from = "year",     #column to get the column names from
                        values_from = "life_exp")#column to get the values from

View(le_wide) 
```

**Exercise**:

Make these data tidy:
 - data\gapminder\children_per_woman_total_fertility.csv
 - data\gapminder\income_per_person_gdppercapita_ppp_inflation_adjusted.csv



# Advanced data manipulation with `dplyr` (Dan)

- join
- group_by (summarise, mutate), 


**Exercise**:

Now using join and pipes, we can built a big table of data containing all variables

```{r}

data <- 
  read_csv("data/gapminder/children_per_woman_total_fertility.csv") %>%   
  pivot_longer(-country, names_to = "year", values_to = "fertility") %>%
  # Add in population
  left_join(by=c("country", "year"),
            read_csv("data/gapminder/population_total.csv") %>%
              pivot_longer(-country, names_to = "year", values_to = "population")
  ) %>%
  # Add in gdp per capita
  left_join(by=c("country", "year"),
            read_csv("data/gapminder/income_per_person_gdppercapita_ppp_inflation_adjusted.csv") %>%   
              pivot_longer(-country, names_to = "year", values_to = "gdp_per_capita")
  ) %>%
  # Add in life expectancy
  left_join(by=c("country", "year"),
            read_csv("data/gapminder/life_expectancy_years.csv") %>%
              pivot_longer(-country, names_to = "year", values_to = "life_expectancy")
  ) %>%
  # Add in life continent
  left_join(by="country",
    read_csv("data/gapminder/continents.csv")
  ) %>% 
  # reorganise data
  select(continent, country, year, everything()) %>% 
  arrange(continent, country, year) %>% 
  mutate(year = as.integer(year))
```

What about Na's?

```{r}
filter(data, is.na(continent))
filter(data, is.na(continent)) %>% pull(country) %>% unique()

```


What to do when your big pipe thingo doesn't work?


# Advanced data visualisation with `ggplot2` (Will)

This session will show you some more advanaced plotting techniques, building on the basic plots from Day 1 and using the gapminder data


## Adjusting labels, sclaes, paletters

Is now achieved via the `scales` packages

```{r}
library(scales)
```


```{r}
data %>% 
  filter(year==1900) %>%
  ggplot(aes(gdp_per_capita, life_expectancy, colour = continent, size=sqrt(population))) + 
  geom_point() + 
  scale_x_log10() + scale_y_log10() +
  labs(x = "GDP per capita ($)", y = "life expectancy (yr)") + 
  theme_classic()
```

## Facets


```{r}
data %>% 
  filter(year %in% seq(1800, 2020, by =20)) %>%
  ggplot(aes(gdp_per_capita, life_expectancy, colour = continent, size=population)) + 
  theme_classic()
  geom_point(alpha = 0.7, show.legend = FALSE) +
  scale_x_log10() + scale_y_log10() +
  scale_size(range = c(2, 12)) +
  labs(x = "GDP per capita ($)", y = "life expectancy (yr)") + 
  theme_classic() +
  facet_wrap(~year)
```

## Themes


Can add a theme onto plot

```{r}

+ theme_classic()
```

Can also set default theme

```{r}
theme_set()
```


## Adding fitted lines

Can use lines `geom_smooth` to fit lines


## Multiple plot layouts with `patchwork`


# Data wrangling & visualisation challenge (Dan)


# ggplot in talks (Dan)
	
# ggplot extensions (Will)
	
Base R vs ggplot

Other packages that build on ggplot

- hexbinplot
- ggbeeswarm
- plotly
- gganimate


### Animations with gganimate

https://github.com/thomasp85/gganimate

```{r}
library(gganimate)

country_colors <- readRDS("data/gapminder/country_colours.rds")

data %>% 
  filter(!is.na(continent)) %>% 
  ggplot(aes(gdp_per_capita, life_expectancy, size = population, colour = country)) +
  theme_classic()
  geom_point(alpha = 0.7, show.legend = FALSE) +
  scale_colour_manual(values = country_colors) +
  scale_size(range = c(2, 12)) +
  scale_x_log10() +
  facet_wrap(~continent) +
  # Here comes the gganimate specific bits
  labs(title = 'Year: {frame_time}', x = 'GDP per capita', y = 'life expectancy') +
  transition_time(year) +
  ease_aes('linear')
```


# Reproducible research (Dan)


# Reproducible research with Rmarkdown

**Exercises:**

Discuss with your partner 

- what is meant by Reproducible research?
- what can you do do make your research reproducible?
- who benefits from reproducible research?

## Keys to reproducible research

